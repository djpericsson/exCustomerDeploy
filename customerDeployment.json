{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.1",
    "parameters": {
        "customerName": {
            "type": "string",
            "defaultValue": "Addlevel DEV"
        },
        "partner": {
            "type": "string",
            "defaultValue": "Addlevel AB"
        },
        "resourceGroup": {
            "type": "string",
            "allowedValues": [
                "xfw-bc-we-prod-rg01",
                "xfw-bc-we-prod-rg02"
            ],
            "defaultValue": "xfw-bc-we-prod-rg01",
            "metadata": {
                "description": "The Resource Group to deploy the customer to."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "westeurope"
        }
    },
    "variables": {
        "uniqueCustomerString": "[concat('ex', uniqueString(subscription().subscriptionId, parameters('CustomerName')))]",
        "customerResourceGroupName": "[parameters('resourceGroup')]",
        "saasResourceGroupName": "SAASServices",
        "globalConfiguration": {
            "subscriptionId": "[subscription().subscriptionid]",
            "Partner": "[parameters('partner')]",
            "tenantDomain": "[tenant().name]",
            "storage": {
                "type": "Standard_LRS",
                "containers": ["attachments", "documents", "exflowdiagnostics"]
            },
            "corsRules": {
                "allowedHeaders": [
                    "x-ms-meta-abc",
                    "Content-Encoding",
                    "Content-Range",
                    "Accept-Ranges",
                    "x-ms-meta-data*",
                    "x-ms-meta-target*"
                ],
                "allowedOrigins": ["[concat('http://', variables('uniqueCustomerString'), '.exflow.debug')]", "[concat('https://', variables('uniqueCustomerString'), '.', tenant().name]"],
                "maxAgeInSeconds": 0,
                "exposedHeaders": ["Accept-Ranges", "Content-Range", "Content-Encoding", "Content-Length", "Content-Type"],
                "allowedMethods": ["Get"]
            },
            "dnsRecordSet": {
                "name": "[variables('uniqueCustomerString')]",
                "recordType": "CNAME",
                "ttl": 3600,
                "dnsRecords": "[concat(variables('uniqueCustomerString'), '.azurewebsites.net')]",
                "resourceGroupName": "[variables('saasResourceGroupName')]"
            },
            "webApp": {
                "name": "[variables('uniqueCustomerString')]",
                "sourceRepoURI": "https://signupsoftware.visualstudio.com/$Project/_apis/build/builds/$buildID/artifacts?api-version=4.1",
                "appServicePlan": "[variables('customerResourceGroupName')]",
                "OutboundIpAddresses": "[OutboundIpAddresses]",
                "AzureRmWebAppSSLBinding": "[AzureRmWebAppSSLBinding]",
                "appSettings": {
                    "applicationInsightsInstrumentationKey": "[AppInsightsKey]",
                    "APPINSIGHTS_INSTRUMENTATIONKEY": "[AppInsightsKey]",
                    "APPINSIGHTS_PORTALINFO": "[APPPORTALINFO]",
                    "APPINSIGHTS_PROFILERFEATURE_VERSION": "[APPPROFILERVERSION]",
                    "startup.DeploymentName": "[variables('uniqueCustomerString')]",
                    "Startup.HostRightPart": ".[tenant().name]",
                    "Startup.AzureKeyVaultURL": "[CustomerKeyVault]",
                    "offline_": "85.24.197.82"
                }
            },
            "keyVault": {
                "name": "[variables('uniqueCustomerString')]",
                "contentType": "CustomerDeployment",
                "vaultName": "[variables('uniqueCustomerString')]",
                "sku": "Standard",
                "applicationSettings": {
                    "FormsTestSitePassword": "[FormsTestSitePassword]",
                    "security_Admins": "[SecurityAdmins]",
                    "clientTypeName": "ExFlow.Logic.NAVServiceReference20170921.EXFWEB_PortClient,ExFlow.Logic",
                    "StorageConnection": "DefaultEndpointsProtocol=https;AccountName=[DeploymentName];AccountKey=[StorageKey];EndpointSuffix=core.windows.net",
                    "KeyValueStorageConnection": "DefaultEndpointsProtocol=https;AccountName=[DeploymentName];AccountKey=[StorageKey];EndpointSuffix=core.windows.net",
                    "aad_TenantId": "",
                    "security_TicketFormsTestSiteUsers": "[TicketFormsTestSiteUsers]",
                    "company": "[Company]",
                    "userName": "[ServiceUsername]",
                    "address": "[ServiceEndpoint]",
                    "aad_ClientSecret": "",
                    "AppControlMergeFile": "[AppControlMergeFile]",
                    "password": "[ServicePassword]",
                    "aad_PostLogoutRedirectUri": "https://[CustomerShortname].[TenantName]/ExFlowDynamics/close.aspx?signedout=yes",
                    "aad_ClientId": "",
                    "aad_AADInstance": "",
                    "endpointName": "ExFlowSSL20170921_Port"
                }
            },
            "hybridConnection": {
                "name": "[variables('uniqueCustomerString')]",
                "nameSpace": "[variables('uniqueCustomerString')]",
                "enabled": false
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2018-05-01",
            "location": "[parameters('location')]",
            "name": "[variables('customerResourceGroupName')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "[concat(variables('identityResourceGroupName'),'-Deployment')]",
            "resourceGroup": "[variables('customerResourceGroupName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('customerResourceGroupName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.KeyVault/vaults",
                            "name": "[variables('uniqueCustomerString')]",
                            "apiVersion": "2016-10-01",
                            "location": "[parameters('location')]",
                            "properties": {
                                "enabledForDeployment": true,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": true,
                                "tenantId": "[subscription().tenantId]",
                                "accessPolicies": [],
                                "sku": {
                                    "name": "Standard",
                                    "family": "A"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.KeyVault/vaults/secrets",
                            "name": "[concat(variables('uniqueCustomerString'), '/globalConfiguration')]",
                            "apiVersion": "2015-06-01",
                            "properties": {
                                "value": "[variables('globalConfiguration')]"
                            }
                        }
                    ]
                }
            }
        }
    ]
}
